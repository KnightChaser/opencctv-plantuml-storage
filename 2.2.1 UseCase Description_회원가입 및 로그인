• 유스케이스명: 회원가입 및 로그인
• 유스케이스 ID : UC01
• 액터명: 사용자 (User)
• 유스케이스 개요: 사용자는 OpenCCTV Web UI를 통해 계정을 생성하고, 로그인하여 Access Token을 발급받는다. 로그인 이후 시스템은 사용자의 역할(Role)에 따라 접근 권한을 제어하며, 모든 권한은 RBAC(Role-Based Access Control) 모델을 기반으로 관리된다.
• 사전 조건:
사용자는 Web UI를 통해 시스템에 접근 가능한 상태여야 한다.
인증 서버(Keycloak) 및 Web API 서버는 정상 동작 상태여야 한다.
사용자에게 초기 Role(예: Viewer)이 부여될 수 있는 정책이 준비되어 있어야 한다.
• 이벤트 흐름
- 정상 흐름
사용자는 OpenCCTV Web UI에서 “회원가입” 버튼을 클릭한다.
시스템은 사용자로부터 username, email, password 정보를 입력받는다.
입력된 정보는 Auth 서버(Keycloak)에 전달되어 User 객체가 생성된다.
초기 값으로 emailVerified = false, createdAt = 현재 시간으로 저장된다.
Keycloak은 이메일 인증 요청을 사용자에게 발송한다.
사용자가 이메일을 인증하면 emailVerified가 true로 변경된다.
사용자는 로그인 페이지에서 username과 password를 입력하고 로그인 요청을 보낸다.
Keycloak은 해당 사용자 정보를 확인하고 JWT(Token)을 발급한다.
이 JWT는 Session 클래스에 매핑되어 저장된다 (issuedAt, expiresAt 포함).
로그인 성공 시 User의 lastLogin 필드가 현재 시간으로 갱신된다.
사용자에게는 Role이 할당되어 있으며, Role에는 Permission 목록이 연관된다.
클라이언트는 REST API 요청 시 JWT를 Authorization 헤더에 포함시켜 전송한다.
서버는 토큰을 디코드하고, User–Role–Permission 체계를 기반으로 RBAC 검증을 수행한다.
검증된 요청만 기능에 접근할 수 있으며, 권한이 없으면 접근이 거부된다.
- 선택 흐름:
사용자가 이메일 인증을 생략하거나 실패하면, 로그인은 제한되고 emailVerified 값이 false 상태로 유지된다.
사용자는 기본적으로 Viewer 권한을 부여받으며, 이후 시스템 관리자가 Operator 또는 Admin 역할을 할당할 수 있다.
- 예외 흐름:
입력된 email이 이미 등록되어 있으면 “이미 가입된 사용자” 메시지를 반환하고 회원가입이 차단된다.
로그인 중 비밀번호가 여러 번 틀리면, 계정이 일시적으로 잠금될 수 있다.
JWT 토큰의 accessExpiresAt이 현재 시각보다 이전이면 access token은 만료된 것으로 간주된다.
refreshExpiresAt까지 만료된 경우, 사용자는 재로그인을 요청받는다.
서버는 토큰이 없거나 변조된 경우, “권한 없음(Unauthorized)” 응답을 반환한다.
